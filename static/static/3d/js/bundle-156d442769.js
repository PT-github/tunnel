!function(){"use strict";class t{constructor(){}}t.DEVICE_TYPE_QB_BOARD=1,t.DEVICE_TYPE_QB_BOARD_F=2,t.DEVICE_TYPE_DRAUGHT=3,t.DEVICE_TYPE_LIGHT01=4,t.DEVICE_TYPE_ALERTOR=5,t.DEVICE_TYPE_PHONE=6,t.DEVICE_TYPE_LIGHT_GRUOP=7,t.DEVICE_TYPE_SIGNAL_LAMP=8,t.DEVICE_TYPE_LAMP_INDICATOR=9,t.DEVICE_TYPE_DOOR=10,t.DEVICE_TYPE_BROADCAST=11,t.DEVICE_TYPE_CAM=12,t.DEVICE_TYPE_TEXT_DIS=100,t.DEVICE_TYPE_HENGDONG1=101,t.DEVICE_TYPE_HENGDONG2=102;class e extends Laya.Sprite3D{constructor(t,e=null){super(),this._roadID=0,this._nodeType=0,this._defaultLength=5,this._showLength=50,this._lastNode=e,e&&(e._nextNode=this),this._nodeType=t;let s="sd_suidao01";switch(t){case 0:break;case 1:case 2:s="sd_rukou01",this._defaultLength=36;break;case 3:s="sd_suidao02";break;case 4:s="sd_suidao02_xiaoyou";break;case 5:s="sd_suidao02_xiaozuo";break;case 6:s="sd_suidao02_you";break;case 7:s="sd_suidao02_zuo"}this.showLength=this._defaultLength,Laya.Sprite3D.load("res/LayaScene_suidao/Conventional/"+s+".lh",Laya.Handler.create(this,this.loadMeshEnd)),this.name=s}loadMeshEnd(t){switch(t.transform.position.toDefault(),t.transform.localPosition.toDefault(),this._meshNode=Laya.Sprite3D.instantiate(t,this),this._meshNode.transform.localScale.setValue(1,1,1),this._meshNode.transform.localPosition.toDefault(),this._nodeType){case 1:this._meshNode.transform.localPosition.setValue(.47,5.23,0);break;case 2:this._meshNode.transform.localPosition.setValue(-.4,5.23,0),this._meshNode.transform.rotate(new Laya.Vector3(0,0,180),!0,!1);break;case 5:this._meshNode.transform.localPosition.setValue(0,4.515,0);break;case 6:this._meshNode.transform.localPosition.setValue(.15,0,0);break;case 3:case 0:this.setSubMaterialAttr(this._meshNode.getChildByName("sd_qiangbi01 1")),this.setSubMaterialAttr(this._meshNode.getChildByName("sd_qiangbi01")),this.setSubMaterialAttr(this._meshNode.getChildByName("lumian01")),this.setSubMaterialAttr(this._meshNode.getChildByName("lumian02"))}this._meshNode.transform.localScale=this._meshNode.transform.localScale,this._meshNode.transform.localPosition=this._meshNode.transform.localPosition,this.loaded&&(this.loaded.run(),this.loaded=null);let e=this._meshNode.getChildByName("lumian01");if(e){e.active=3==g.tunnelMgr.laneNums;let t=this._meshNode.getChildByName("lumian02");t&&(t.active=2==g.tunnelMgr.laneNums)}}get showLength(){return this._showLength}set showLength(t){this._showLength=t;let e=t/this._defaultLength;this.transform.localScale.z=e,this.transform.localScale=this.transform.localScale;let s=-t/2;this._lastNode?s+=this._lastNode.getNextNodePos():s+=t,this.transform.localPosition.z=s,0!=this._roadID&&(this.transform.localPosition.x=-50*this._roadID),this.transform.localPosition=this.transform.localPosition}getNextNodePos(){return this.transform.localPosition.z-this._showLength/2}setSubMaterialAttr(t){if(t){if(t instanceof Laya.MeshSprite3D){t.meshRenderer.material.tilingOffsetX=this._showLength/this._defaultLength}for(let e=0;e<t.numChildren;++e)this.setSubMaterialAttr(t.getChildAt(e))}}}class s extends Laya.Script3D{constructor(){super(),this._albedoColor=new Laya.Vector4(.6,.6,.6,1),this._defaultX=7,this._camerOffsetHeight=5,this._camerOffsetDis=10,this._camerLookHeight=0}changeData(t){}onAwake(){if(this.nodeSprite=this.owner.parent,1e4==this._defaultX)return;let t=0;if(this.nodeSprite.DeviceData){switch(this.nodeSprite.DeviceData.orientationLocation){case 18:case 16:case 17:case 0:t=-this._defaultX;break;case 10:case 12:case 13:case 14:case 15:t=this._defaultX;break;case 1:case 2:case 3:t=this.nodeSprite.tunnelSprite.getRoadPosX(this.nodeSprite.DeviceData.orientationLocation)}switch(this.nodeSprite.DeviceData.orientationLocation){case 0:case 10:case 12:case 13:case 14:case 15:case 16:case 18:case 17:1==this.nodeSprite.tunnelSprite.posType&&(t=-t),t<0&&this.nodeSprite.transform.rotate(new Laya.Vector3(0,180,0),!0,!1)}}0!=t&&(this.nodeSprite.transform.localPosition.x=t,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition)}onMouseClick(){this.cameraMoveToLook()}cameraMoveToLook(){let t=s.TEMP_CAMERA_POS;this.nodeSprite.transform.getForward(t),t.x*=-this._camerOffsetDis,t.y*=this._camerOffsetDis,t.z*=-this._camerOffsetDis,t.y+=this._camerOffsetHeight,Laya.Vector3.add(this.nodeSprite.transform.position,t,t),this.nodeSprite.transform.position.cloneTo(g.CameraScript.curLookPos),g.CameraScript.curLookPos.y+=this._camerLookHeight,g.CameraScript.tweenMoveTo(t,500,null,g.CameraScript.curLookPos);let e=this.nodeSprite.name;if(this.nodeSprite.DeviceData){e=JSON.stringify(this.nodeSprite.DeviceData);let t={msgType:"clickDevice",msgData:this.nodeSprite.DeviceData};Laya.Browser.window.parent.postMessage(t)}S.instance.textSelect.text="当前选中："+e}onUpdate(){}onMouseEnter(){this.showSelectEffect(!0)}onMouseOut(){this.showSelectEffect(!1)}showSelectEffect(t){t?this.setSubMaterialAttr(this.owner,"albedoColor",this._albedoColor):this.setSubMaterialAttr(this.owner,"albedoColor")}setSubMaterialAttr(t,e,s=null,a=null){if(a||(a=e+"_back"),t instanceof Laya.MeshSprite3D){let i=t.meshRenderer.material;i[a]||(i[a]=i[e]),i[e]=s||i[a]}for(let i=0;i<t.numChildren;++i)this.setSubMaterialAttr(t.getChildAt(i),e,s,a)}}s.TEMP_CAMERA_POS=new Laya.Vector3(0,1,0);class a extends s{constructor(){super()}onAwake(){switch(this.nodeSprite=this.owner.parent,this.nodeSprite.deviceType){case t.DEVICE_TYPE_ALERTOR:this._defaultX=7;break;case t.DEVICE_TYPE_PHONE:this._defaultX=7.2;break;case t.DEVICE_TYPE_BROADCAST:this._defaultX=6.2;break;case t.DEVICE_TYPE_CAM:this._defaultX=6.17}super.onAwake()}onStart(){this._camerOffsetDis=5,this._camerOffsetHeight=0;let e=0;switch(this.nodeSprite.deviceType){case t.DEVICE_TYPE_ALERTOR:e=2.1;break;case t.DEVICE_TYPE_PHONE:e=1.45;break;case t.DEVICE_TYPE_BROADCAST:e=3.4;break;case t.DEVICE_TYPE_CAM:e=4.96}this.nodeSprite.transform.localPosition.y=e,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,this.nodeSprite.transform.rotate(new Laya.Vector3(0,-90,0),!0,!1)}}class i{static createText3D(t,e=50,s="rgb(240,0,0)",a="宋体"){let i=t.split(/[\n]/),o=0,n=i.length;i.forEach(t=>{let s=t.replace(/[\u0391-\uFFE5]/g,"aa").length/2*(e+2);o=Math.max(s,o)});let r=o;r=Math.max(r,3*e);let h=Laya.Browser.createElement("canvas");var l=h.getContext("2d");h.width=r,h.height=e*n,l.fillStyle=s,l.font="bold "+e+"px "+a,l.textAlign="left",l.textBaseline="top";for(let t=0;t<n;++t)l.fillText(i[t],0,t*e);let c=new Laya.Texture2D(128,128);return c.loadImageSource(h),Laya.Browser.removeElement(h),c}}class o extends s{constructor(){super()}onStart(){if(this.meshsp=this.owner,this.meshsp.transform.localPosition.y=.3,this.meshsp.transform.localPosition=this.meshsp.transform.localPosition,this.nodeSprite.showData)this.nodeSprite.DeviceData||(this.meshsp.transform.localScale=new Laya.Vector3(1,1,.35)),this.setText(this.nodeSprite.showData,"宋体");else{let t=-this.meshsp.parent.transform.localPosition.z;this.setText(t+"M","宋体");let e=this.meshsp.parent;e.transform.localPosition=e.transform.localPosition}1==this.nodeSprite.tunnelSprite.posType&&this.meshsp.transform.rotate(new Laya.Vector3(0,180,0),!0,!1)}setText(t,e){let s=i.createText3D(t,50,"rgb(240,240,240)",e);this.meshsp.meshRenderer.material.texture=s}}class n extends s{constructor(){super(),this._rotateType=0}onStart(){super.onAwake(),this._camerOffsetHeight=.5,this._fengshanMesh=this.owner.getChildByName("sd_wj_sd_fengji01_02"),this.nodeSprite.transform.localPosition.y=7,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,this._rotateType=2,this.updateState()}onUpdate(){if(super.onUpdate(),this._fengshanMesh)switch(this._rotateType){case 1:this._fengshanMesh.transform.rotate(n.ROTATE_TYPE_VALUE_1);break;case 2:this._fengshanMesh.transform.rotate(n.ROTATE_TYPE_VALUE_2)}}updateState(){this._rotateType=this.nodeSprite.DeviceData.deviceCommunicationsState}changeData(t){super.changeData(t),this.updateState()}}n.ROTATE_TYPE_VALUE_1=new Laya.Vector3(0,.1,0),n.ROTATE_TYPE_VALUE_2=new Laya.Vector3(0,-.1,0);class r extends s{constructor(){super()}onAwake(){this._defaultX=7,super.onAwake()}onStart(){this._camerOffsetDis=5,this._camerOffsetHeight=0,this.nodeSprite.transform.localPosition.x=-14.359,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition}}class h extends s{constructor(){super(),this._imgList=new Array("sd_jinzhi02","sd_zhengxiang01","sd_jinzhi02","sd_zuozhuan01"),this._imgList2=new Array("sd_jinzhi01","sd_zhengxiang02","sd_jinzhi011","sd_zuozhuan02")}onAwake(){super.onAwake()}onStart(){super.onStart(),this._camerOffsetDis=5,this._camerOffsetHeight=0,this.nodeSprite.transform.localPosition.y=7,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,this.nodeSprite.transform.localPositionZ<-10&&this.nodeSprite.transform.rotate(new Laya.Vector3(0,180,0),!0,!1),this.changeData()}changeData(){let t=this.owner;for(let e=0;e<this._imgList.length;++e){let s=t.getChildByName(this._imgList[e]);s&&(s.active=!1);let a=t.getChildByName(this._imgList2[e]);a&&(a.active=!1)}let e=t.getChildByName(this._imgList[this.nodeSprite.DeviceData.deviceCommunicationsState]);e&&(e.active=!0),2==this.nodeSprite.DeviceData.deviceCommunicationsState?(e=t.getChildByName(this._imgList2[1])).active=!0:(e=t.getChildByName(this._imgList2[0])).active=!0}}class l extends s{constructor(){super()}onAwake(){this._defaultX=4,super.onAwake()}onStart(){super.onStart(),this._camerOffsetDis=5,this._camerOffsetHeight=0,this.nodeSprite.transform.localPosition.y=7,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,this.nodeSprite.transform.rotate(new Laya.Vector3(0,-90,0),!0,!1),this.changeData()}setOpen(t){let e=this.owner.getChildByName("sd_dadeng02");e.getChildAt(0).active=t;let s=e.meshRenderer.material;s.colorA=t?1:.1}changeData(){this.setOpen(1==this.nodeSprite.DeviceData.deviceCommunicationsState)}}class c extends s{constructor(){super()}onAwake(){this.nodeSprite=this.owner.parent,this._defaultX=7,17==this.nodeSprite.DeviceData.orientationLocation&&(this._defaultX=16),super.onAwake()}onStart(){if(this._camerOffsetDis=5,this._camerOffsetHeight=0,this.nodeSprite.transform.localPosition.y=3.2,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,17!=this.nodeSprite.DeviceData.orientationLocation)this.nodeSprite.transform.rotate(new Laya.Vector3(0,-90,0),!0,!1);else{let t=this.owner;t.transform.localPosition.z=-4,t.transform.localPosition=t.transform.localPosition}this.changeData()}setOpen(t){let e=this.owner;for(let s=0;s<6;s++){let a=e.getChildAt(s),i=a.getChildAt(0),o=a.getChildAt(1);i.active=t,o.active=!t}}changeData(){this.setOpen(1==this.nodeSprite.DeviceData.deviceCommunicationsState)}}class d extends s{constructor(){super()}onStart(){super.onAwake(),this._camerOffsetHeight=15,this._camerLookHeight=4;let e=this.nodeSprite.transform.localPositionZ<-10;if(this.nodeSprite.deviceType==t.DEVICE_TYPE_QB_BOARD_F)this.nodeSprite.transform.localPosition.x=8.6,this.showText(this.nodeSprite.DeviceData.contentText,50),e&&(this.nodeSprite.transform.localPosition.x=7.6);else{let t=this.owner;t.transform.localPosition.y=9.28,t.transform.localPosition=t.transform.localPosition,this.nodeSprite.transform.localPosition.x=0,this.showText(this.nodeSprite.DeviceData.contentText,50)}e&&(this.nodeSprite.transform.localPosition.x=-this.nodeSprite.transform.localPosition.x,this.nodeSprite.transform.rotate(new Laya.Vector3(0,180,0),!0,!1)),this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition}showText(t,e){let s=this.owner.getChildAt(0),a=s.getComponent(Laya.Animator),o=i.createText3D(t,50,"rgb(250,0,0)","Microsoft YaHei");if(s.meshRenderer.material.texture=o,a){let e=t.replace(/[\u0391-\uFFE5]/g,"aa").length;a.speed=10/e}}}class m extends s{constructor(){super(),this._imgs=new Array("sd_lvdeng001","sd_hongdeng001","sd_huangdeng001","sd_zuozhuandeng001","sd_youzhuandeng001")}onAwake(){super.onAwake()}onStart(){super.onStart(),this._camerOffsetDis=5,this._camerOffsetHeight=0,this.nodeSprite.transform.localPosition.x=0,this.nodeSprite.transform.localPosition.y=7,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,this.nodeSprite.transform.localPositionZ<-10&&this.nodeSprite.transform.rotate(new Laya.Vector3(0,180,0),!0,!1),this.changeData()}changeData(){let t=this.owner;for(let e=0;e<this._imgs.length;++e){t.getChildByName(this._imgs[e]).active=this.nodeSprite.DeviceData.deviceCommunicationsState==e}}}class u extends s{constructor(){super()}onAwake(){this._defaultX=6.6,super.onAwake()}onStart(){this._camerOffsetDis=5,this._camerOffsetHeight=5;let t=this.owner;t.transform.localPosition.x=4.6,this.nodeSprite.transform.localPosition.x>0&&(t.transform.localPosition.x=-.3),t.transform.localPosition=t.transform.localPosition,this.nodeSprite.transform.localPosition.y=2.41,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,this.nodeSprite.transform.rotate(new Laya.Vector3(0,-90,0),!0,!1),this.changeData()}changeData(){let t=this.owner.getChildByName("sd_juanzhamen01");switch(this.nodeSprite.DeviceData.deviceCommunicationsState){case 0:break;case 1:t.active=!1;break;case 2:t.active=!0}}}class _ extends Laya.Sprite3D{constructor(e){switch(super(),this._deviceType=e,this._deviceType){case t.DEVICE_TYPE_QB_BOARD:this.loadItem("sd_qingbaoban02");break;case t.DEVICE_TYPE_QB_BOARD_F:this.loadItem("sd_qingbaoban01");break;case t.DEVICE_TYPE_DRAUGHT:this.loadItem("sd_wj_sd_fengji01");break;case t.DEVICE_TYPE_LIGHT01:this.loadItem("sd_dadeng01");break;case t.DEVICE_TYPE_TEXT_DIS:this.loadItem("textdis");break;case t.DEVICE_TYPE_ALERTOR:this.loadItem("sd_huozhaijingbao01");break;case t.DEVICE_TYPE_PHONE:this.loadItem("sd_dianhua01");break;case t.DEVICE_TYPE_BROADCAST:this.loadItem("sd_guangbo01");break;case t.DEVICE_TYPE_LIGHT_GRUOP:this.loadItem("dengzu01");break;case t.DEVICE_TYPE_SIGNAL_LAMP:this.loadItem("sd_xinhaodeng01");break;case t.DEVICE_TYPE_LAMP_INDICATOR:this.loadItem("sd_daoluzhishideng01");break;case t.DEVICE_TYPE_HENGDONG1:this.loadItem("sd_hengdao02");break;case t.DEVICE_TYPE_HENGDONG2:this.loadItem("sd_hengdao01");break;case t.DEVICE_TYPE_DOOR:this.loadItem("suidaomen01");break;case t.DEVICE_TYPE_CAM:this.loadItem("sd_shexiangtou01")}}loadItem(t){Laya.Sprite3D.load("res/LayaScene_suidao/Conventional/"+t+".lh",Laya.Handler.create(this,this.loadMeshEnd)),this.name=t}get tunnelSprite(){return this.parent}get deviceType(){return this._deviceType}getDeviceScirpt(){let t=this.getChildAt(0);return t?t.getComponent(s):null}loadMeshEnd(e,s=!1){let i=e;switch(s?this.addChild(e):(e.transform.position.toDefault(),e.transform.localPosition.toDefault(),(i=Laya.Sprite3D.instantiate(e,this)).transform.localPosition.toDefault(),i.transform.localPosition=i.transform.localPosition),this._deviceType){case t.DEVICE_TYPE_QB_BOARD_F:case t.DEVICE_TYPE_QB_BOARD:i.addComponent(d);break;case t.DEVICE_TYPE_DRAUGHT:i.addComponent(n);break;case t.DEVICE_TYPE_LIGHT01:i.addComponent(l);break;case t.DEVICE_TYPE_TEXT_DIS:i.addComponent(o);break;case t.DEVICE_TYPE_CAM:case t.DEVICE_TYPE_ALERTOR:case t.DEVICE_TYPE_PHONE:case t.DEVICE_TYPE_BROADCAST:i.addComponent(a);break;case t.DEVICE_TYPE_LIGHT_GRUOP:i.addComponent(c);break;case t.DEVICE_TYPE_SIGNAL_LAMP:i.addComponent(m);break;case t.DEVICE_TYPE_LAMP_INDICATOR:i.addComponent(h);break;case t.DEVICE_TYPE_HENGDONG1:case t.DEVICE_TYPE_HENGDONG2:i.addComponent(r);break;case t.DEVICE_TYPE_DOOR:i.addComponent(u)}}get DeviceData(){return this._deviceData}changeData(t){this._deviceData=t;let e=this.getDeviceScirpt();e&&e.changeData(t)}get showData(){return this._showData}changeShowData(t){this._showData=t;let e=this.getDeviceScirpt();e&&e.changeData(t)}}class p extends Laya.Sprite3D{constructor(){super(),this.TunnelLength=200,this._posType=0,this.RoadCount=3,this._nodeList=new Array,this._startMark=0,this._disText="方向显示"}get posType(){return this._posType}set startMark(t){this._startMark=t}get startMark(){return this._startMark}getRoadPosX(t){let e=0;switch(t){case 1:e=-3.7,2==g.tunnelMgr.laneNums&&(e=-2.7);break;case 2:2==g.tunnelMgr.laneNums&&(e=2.7);break;case 3:e=3.8}return 1==this.posType&&(e=-e),e}init(s,a,i){this.TunnelLength=s,this._posType=a,this.name="TunnelSprite"+this._posType;let o=Math.floor(this.TunnelLength/100)+1;for(let e=0;e<o;++e){this.addChild(new _(t.DEVICE_TYPE_TEXT_DIS)).transform.localPosition.z=-100*e}let n=[];for(let t=0;t<i.length;++t){let e={data:i[t],pos:i[t].pileNumber-this.startMark};e.data.leftRightFlag!=a+1&&3!=e.data.leftRightFlag||n.push(e)}n.sort(function(t,e){return t.pos-e.pos});let r=new e(1);this.addChild(r),this._nodeList.push(r);let h=r,l=0;for(let s=0;s<n.length;++s){if(l<n[s].pos){let t=new e(0,h);t.showLength=n[s].pos-l,this.addChild(t),this._nodeList.push(t),h=t,l=n[s].pos}let a=0,i=5,o=0;switch(n[s].data.emptyType){case 0:a=3,i=n[s].data.length;break;case 1:a=0==this.posType?4:5,o=t.DEVICE_TYPE_HENGDONG1;break;case 2:a=0==this.posType?6:7,o=t.DEVICE_TYPE_HENGDONG2}if(0==this.posType&&0!=o){let t=this.addChild(new _(o));t.changeData(n[s].data),t.transform.localPosition.z=h.getNextNodePos()-i/2}let r=new e(a,h);r.showLength=i,r.addData=n[s].data,this.addChild(r),this._nodeList.push(r),h=r,l+=r.showLength}if(l<this.TunnelLength){let t=new e(0,h);t.showLength=this.TunnelLength-l,this.addChild(t),this._nodeList.push(t),h=t}let c=new e(2,h);this.addChild(c),this._nodeList.push(c),this.transform.localPosition.x=-28.6*a,this.transform.localPosition=this.transform.localPosition}findHengDongNode(t){for(let e=0;e<this._nodeList.length;++e){let s=this._nodeList[e];if(s.addData&&s.addData.pileNumber==t)return s}return null}addDevice(e){let s=e.pileNumber-this.startMark,a=0;switch(e.deviceTypeCode){case"signallamp":a=t.DEVICE_TYPE_SIGNAL_LAMP;break;case"laneIndicator":a=t.DEVICE_TYPE_LAMP_INDICATOR;break;case"urgentphone":a=t.DEVICE_TYPE_PHONE;break;case"controller":break;case"broadcast":a=t.DEVICE_TYPE_BROADCAST;break;case"conflagration":a=t.DEVICE_TYPE_ALERTOR;break;case"guidelight":break;case"lighting":a=t.DEVICE_TYPE_LIGHT01;break;case"lightingloop":a=t.DEVICE_TYPE_LIGHT_GRUOP;break;case"waterlevel":case"electronicfence":case"environment":break;case"tunneldoor":a=t.DEVICE_TYPE_DOOR;break;case"draughtfan":a=t.DEVICE_TYPE_DRAUGHT;break;case"video":a=t.DEVICE_TYPE_CAM;break;case"intelligenceboard":switch(e.deviceSubtypeCode){case"M":a=t.DEVICE_TYPE_QB_BOARD;break;case"F":a=t.DEVICE_TYPE_QB_BOARD_F}}if(0==a)return null;let i=this.addChild(new _(a));return i.changeData(e),i.transform.localPosition.z=-s,i}setDirText(e){this._disText=e+"->->";let s=this.addChild(new _(t.DEVICE_TYPE_TEXT_DIS));s.changeShowData(this._disText),0==this._posType?s.transform.localPosition.setValue(15,-1,20):s.transform.localPosition.setValue(-15,-1,20),s.transform.localPosition=s.transform.localPosition;let a=this.addChild(new _(t.DEVICE_TYPE_TEXT_DIS));a.changeShowData(this._disText),0==this._posType?a.transform.localPosition.setValue(15,-1,20-this.TunnelLength-40):a.transform.localPosition.setValue(-15,-1,20-this.TunnelLength-40),a.transform.localPosition=a.transform.localPosition;let i=Math.floor(this.TunnelLength/250)+1;for(let e=1;e<i;++e){let s=this.addChild(new _(t.DEVICE_TYPE_TEXT_DIS));s.changeShowData(this._disText),s.changeData(!0),s.transform.localPosition.z=-10-250*e,s.transform.localPosition=s.transform.localPosition}}getStartView(){return this._nodeList[0].getChildAt(0).getChildByName("view")}getEndView(){return this._nodeList[this._nodeList.length-1].getChildAt(0).getChildByName("view")}}class g{}g.tunnelMgr=new class{constructor(){this.TunnelCount=2,this.laneNums=2,this._deviceList=new Map,this._maxLength=0}init(t){}getMaxLenth(){return this._maxLength}loadTunnel(t,e){this.InitData=t,this.laneNums=t.laneNums,this._maxLength=Math.max(t.leftHoleLength,t.rightHoleLength);let s=new p;g.GameScene.addChild(s),3==t.singleDoubleType||t.singleDoubleType,s.RoadCount=t.laneNums,s.startMark=t.startStakeMark,s.init(t.leftHoleLength,1,e),s.setDirText(t.leftHoleDirection),s.transform.position.z=t.startStakeMarkRight-t.startStakeMark,s.transform.position=s.transform.position,this._leftTunnelSprite=s;let a=new p;g.GameScene.addChild(a),3==t.singleDoubleType||t.singleDoubleType,a.RoadCount=t.laneNums,a.startMark=t.startStakeMarkRight,a.init(t.rightHoleLength,0,e),a.setDirText(t.rightHoleDirection),this._rightTunnelSprite=a}findDevice(t){return this._deviceList[t]}addDevice(t){let e=this.findDevice(t.id);e?e.changeData(t):(e=1==t.leftRightFlag?this._rightTunnelSprite.addDevice(t):this._leftTunnelSprite.addDevice(t),this._deviceList[t.id]=e)}addDevices(t){for(let e=0;e<t.length;++e)this.addDevice(t[e])}getCurView(t){if(!this._viewList){this._viewList=new Array,this._viewList.push(this._rightTunnelSprite.getStartView()),this._viewList.push(this._rightTunnelSprite.getEndView()),this._viewList.push(this._leftTunnelSprite.getEndView()),this._viewList.push(this._leftTunnelSprite.getStartView());for(let t=0;t<this._viewList.length;++t)this._viewList[t].active=!1}return this._viewList.length<=t?null:this._viewList[t]}};var f,E=Laya.Scene,D=Laya.ClassUtils.regClass;!function(t){!function(t){class e extends E{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("test/TestScene")}}t.TestSceneUI=e,D("ui.test.TestSceneUI",e)}(t.test||(t.test={}))}(f||(f={}));class S extends f.test.TestSceneUI{constructor(){super(),S.instance=this,this.btnReset.on(Laya.Event.CLICK,this,this.onClickReset),this.btnAutoView.on(Laya.Event.CLICK,this,this.onClickAutoView),this.siderMainLenth.changeHandler=new Laya.Handler(this,this.onChangeLenth),this.siderMainLenth.max=g.tunnelMgr.getMaxLenth(),this.siderMainLenth.visible=!1}onClickReset(){g.CameraScript.reset(),this.textSelect.text="当前选中：无"}onClickAutoView(){g.CameraScript.autoView(!g.CameraScript.autoStat)}updateViewShow(){g.CameraScript.autoStat?this.btnAutoView.label="停止巡游":g.CameraScript.stopBackView?this.btnAutoView.label="继续巡游":this.btnAutoView.label="自动巡游"}onChangeLenth(t){}setShowPos(t){this.siderMainLenth.value=t}}class L{constructor(){}static init(){(0,Laya.ClassUtils.regClass)("script/GameUI.ts",S)}}L.width=1920,L.height=1080,L.scaleMode="fixedwidth",L.screenMode="none",L.alignV="middle",L.alignH="center",L.startScene="test/TestScene.scene",L.sceneRoot="",L.debug=!1,L.stat=!0,L.physicsDebug=!1,L.exportSceneToJson=!0,L.init();class T extends Laya.Script3D{constructor(){super(),this._initCamerPos=new Laya.Vector3,this._initCamerDir=new Laya.Quaternion,this._moveing=!1,this.curLookPos=new Laya.Vector3,this.autoViewIndex=0,this.autoStat=!1}reset(){this.curLookPos.setValue(0,0,0),this.tweenMoveTo(this._initCamerPos,500,this._initCamerDir)}onAwake(){this.camera=this.owner}onStart(){this.camera.transform.position.cloneTo(this._initCamerPos),this.camera.transform.rotation.cloneTo(this._initCamerDir)}tweenMoveTo(t,e,s=null,a=null,i=null){i||this.stopView();let o=this.camera.transform.position;if(this._moveing=!0,Laya.Tween.clearAll(o),Laya.Tween.to(o,{x:t.x,y:t.y,z:t.z,update:new Laya.Handler(this,function(){this.camera.transform.position=o,a&&this.camera.transform.lookAt(a,T.UP_V3,!1)})},e,null,Laya.Handler.create(this,function(){this.moveOver(),i&&i()})),!a&&s){let t=this.camera.transform.rotation;Laya.Tween.clearAll(t),Laya.Tween.to(t,{x:s.x,y:s.y,z:s.z,w:s.w,update:new Laya.Handler(this,function(){this.camera.transform.rotation=t})},e)}}moveOver(){Laya.Tween.clearAll(this.camera.transform.position),this._moveing=!1}onUpdate(){S.instance&&S.instance.setShowPos(-this.curLookPos.z)}stopView(){this.autoStat&&(this.autoStat=!1,this.stopBackView||(this.stopBackView=new Laya.Vector3),this.camera.transform.position.cloneTo(this.stopBackView),this.moveOver(),S.instance.updateViewShow())}autoView(t){if(!t)return void this.stopView();this.autoStat=t;let e=g.tunnelMgr.getCurView(this.autoViewIndex).transform.position;this.stopBackView&&(this.camera.transform.position=this.stopBackView,this.stopBackView=null),S.instance.updateViewShow();let a=s.TEMP_CAMERA_POS;a.x=0,a.y=0,a.z=3,a.y+=2,Laya.Vector3.add(e,a,a),e.cloneTo(this.curLookPos),this.curLookPos.y+=2;let i=200*Laya.Vector3.distance(a,g.GameCamera.transform.position);this.autoViewIndex%2==0&&(i=400),this.tweenMoveTo(a,i,null,g.CameraScript.curLookPos,function(){g.CameraScript.autoViewIndex++,g.CameraScript.autoViewIndex>3&&(g.CameraScript.autoViewIndex=0),g.CameraScript.autoView(!0)})}}T.UP_V3=new Laya.Vector3(0,1,0);var w=Laya.Vector3,C=Laya.Quaternion;class P extends T{constructor(){super(),this.canRotation_X=!0,this.canRotation_Y=!0,this.canScale=!0,this.AroundPos=new w,this.mouseSettings=new y(0,.3,.3),this.angleRange=new V(-360,360),this.distanceRange=new V(1,80),this.damper=5,this.CurrentAngles=new w,this.CurrentAnglesTemp=new w,this.targetAngles=new w,this.moveV3=new Laya.Vector3,this.FORWORD=new w,this.deltaWheel=0,this.lastMouseX=0,this.lastMouseY=0,this.mouseRunning=!1,this.tempRotationZ=new C,this.tempV=new w,this.tempV1=new w}onStart(){super.onStart(),g.CameraScript=this,this.initTransform(),Laya.stage.on(Laya.Event.MOUSE_DOWN,this,this.mouseDown),Laya.stage.on(Laya.Event.MOUSE_MOVE,this,this.mouseMove),Laya.stage.on(Laya.Event.MOUSE_UP,this,this.mouseUp),Laya.stage.on(Laya.Event.MOUSE_WHEEL,this,this.mouseWheel),Laya.stage.on(Laya.Event.RIGHT_MOUSE_DOWN,this,this.rightMouseDown),Laya.stage.on(Laya.Event.RIGHT_MOUSE_UP,this,this.rightMouseUp)}initTransform(){this.transform=this.camera.transform,this.CurrentAngles.setValue(-this.transform.rotationEuler.x,this.transform.rotationEuler.y,this.transform.rotationEuler.z),this.targetAngles.setValue(-this.transform.rotationEuler.x,this.transform.rotationEuler.y,this.transform.rotationEuler.z),this.curLookPos?this.curLookPos.cloneTo(this.AroundPos):this.AroundPos.setValue(0,0,0),this.CurrentDistance=w.distance(this.transform.position,this.AroundPos),this.targetDistance=w.distance(this.transform.position,this.AroundPos),this.CurrentDistance>50&&(w.scale(this.GetForward,-50,this.tempV),w.subtract(this.transform.position,this.tempV,this.tempV1),this.tempV1.cloneTo(this.AroundPos),this.tempV1.cloneTo(this.curLookPos)),this.CurrentDistance=w.distance(this.transform.position,this.AroundPos),this.targetDistance=w.distance(this.transform.position,this.AroundPos)}moveOver(){super.moveOver(),this.initTransform()}onUpdate(){if(super.onUpdate(),this._moveing)return;this.AroundByMouseInput(),this.canRotation_X||(this.targetAngles.y=0),this.canRotation_Y||(this.targetAngles.x=0);let t=this.GetAxisX,e=this.GetAxisY;if(this.bRightMouseDown){let s=this.transform.rotationEuler.y/180*Math.PI,a=Math.sin(s),i=Math.cos(s),o=2*this.deltaTime;this.moveV3.z=-(e*i-t*a)*o,this.moveV3.x=-(e*a+t*i)*o,this.transform.translate(this.moveV3,!1),Laya.Vector3.add(this.AroundPos,this.moveV3,this.AroundPos),Laya.Vector3.add(this.curLookPos,this.moveV3,this.curLookPos)}else this.CurrentAngles=this.LerpVector3(this.CurrentAngles,this.targetAngles,this.deltaTime*this.damper),this.CurrentDistance=this.LerpNum(this.CurrentDistance,this.targetDistance,this.deltaTime*this.damper),this.CurrentAnglesTemp.x=-this.CurrentAngles.x,this.CurrentAnglesTemp.y=this.CurrentAngles.y,this.CurrentAnglesTemp.z=this.CurrentAngles.z,this.transform.rotationEuler=this.CurrentAnglesTemp,w.scale(this.GetForward,this.CurrentDistance,this.tempV),w.subtract(this.AroundPos,this.tempV,this.tempV1),this.transform.position=this.tempV1;this.lastMouseX=Laya.stage.mouseX,this.lastMouseY=Laya.stage.mouseY}get GetAxisX(){return Laya.stage.mouseX-this.lastMouseX}get GetAxisY(){return Laya.stage.mouseY-this.lastMouseY}get deltaTime(){return Laya.timer.delta/1e3}get GetForward(){return this.transform.getForward(this.FORWORD),this.FORWORD}mouseDown(t){t.target.parent==Laya.Scene.root&&(this.mouseRunning=!0)}mouseMove(t){this.myevent=t}mouseWheel(t){this.deltaWheel=t.delta}mouseUp(t){this.mouseRunning=!1}rightMouseDown(t){this.bRightMouseDown=!0}rightMouseUp(t){this.lastMouseX=Laya.stage.mouseX,this.lastMouseY=Laya.stage.mouseY,this.bRightMouseDown=!1,this.initTransform()}Clamp(t,e,s){return t<e?e:t>s?s:t}LerpVector3(t,e,s){var a=new w;return a.x=t.x+s*(e.x-t.x),a.y=t.y+s*(e.y-t.y),a.z=t.z+s*(e.z-t.z),a}LerpNum(t,e,s){return t+s*(e-t)}AroundByMouseInput(){this.mouseRunning&&(this.targetAngles.y-=this.GetAxisX*this.mouseSettings.pointerSensitivity,this.targetAngles.x+=this.GetAxisY*this.mouseSettings.pointerSensitivity,this.targetAngles.x=this.Clamp(this.targetAngles.x,this.angleRange.min,this.angleRange.max)),this.canScale&&(this.targetDistance-=this.deltaWheel*this.mouseSettings.wheelSensitivity,this.deltaWheel=0,this.targetDistance=this.Clamp(this.targetDistance,this.distanceRange.min,this.distanceRange.max))}}class y{constructor(t,e,s){this.mouseButtonID=t,this.pointerSensitivity=e,this.wheelSensitivity=s}}class V{constructor(t,e){this.min=t,this.max=e}}new class{constructor(){let t=new Config3D;t.isAntialias=!1,window.Laya3D?Laya3D.init(L.width,L.height,t):Laya.init(L.width,L.height,Laya.WebGL),Laya.Physics&&Laya.Physics.enable(),Laya.DebugPanel&&Laya.DebugPanel.enable(),Laya.stage.scaleMode=L.scaleMode,Laya.stage.screenMode=L.screenMode,Laya.stage.alignV=L.alignV,Laya.stage.alignH=L.alignH,Laya.URL.exportSceneToJson=L.exportSceneToJson,(L.debug||"true"==Laya.Utils.getQueryString("debug"))&&Laya.enableDebugPanel(),L.physicsDebug&&Laya.PhysicsDebugDraw&&Laya.PhysicsDebugDraw.enable(),L.stat&&Laya.Stat.show(),Laya.alertGlobalError(!0),Laya.ResourceVersion.enable(Laya.Browser.window._VERSION_JSON||"version.json",Laya.Handler.create(this,this.onVersionLoaded),Laya.ResourceVersion.FILENAME_VERSION)}onVersionLoaded(){Laya.AtlasInfoManager.enable("fileconfig.json",Laya.Handler.create(this,this.onConfigLoaded))}onConfigLoaded(){Laya.Scene3D.load("res/LayaScene_suidao/Conventional/suidao.ls",Laya.Handler.create(this,this.onLoadScene))}onLoadScene(t){if(Laya.stage.addChild(t),g.GameScene=t,g.GameCamera=t.getChildByName("Main Camera"),g.GameCamera.addComponent(P),g.tunnelMgr.init(t),Laya.Browser.window.addEventListener("message",function(t){let e=t.data;switch(e.msgType){case"loadTunnel":g.tunnelMgr.loadTunnel(e.msgData,e.addData),L.startScene&&Laya.Scene.open(L.startScene);break;case"addDevice":g.tunnelMgr.addDevice(e.msgData);break;case"addDevices":g.tunnelMgr.addDevices(e.msgData)}}),Laya.Browser.window.parent){let t={msgType:"loaded"};Laya.Browser.window.parent.postMessage(t)}}}}();