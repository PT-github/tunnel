!function(){"use strict";class t{constructor(){}}t.DEVICE_TYPE_QB_BOARD=1,t.DEVICE_TYPE_QB_BOARD_F=2,t.DEVICE_TYPE_DRAUGHT=3,t.DEVICE_TYPE_DRAUGHT2=1003,t.DEVICE_TYPE_LIGHT01=4,t.DEVICE_TYPE_ALERTOR=5,t.DEVICE_TYPE_PHONE=6,t.DEVICE_TYPE_LIGHT_GRUOP=7,t.DEVICE_TYPE_SIGNAL_LAMP=8,t.DEVICE_TYPE_LAMP_INDICATOR=9,t.DEVICE_TYPE_DOOR=10,t.DEVICE_TYPE_BROADCAST=11,t.DEVICE_TYPE_CAM=12,t.DEVICE_TYPE_SENSOR=13,t.DEVICE_TYPE_LIGHT_GRUOP2=14,t.DEVICE_TYPE_LIGHT_ROAD=15,t.DEVICE_TYPE_TEXT_DIS=100,t.DEVICE_TYPE_HENGDONG1=101,t.DEVICE_TYPE_HENGDONG2=102,t.DEVICE_TYPE_JIFANG1=103;class e extends Laya.Sprite3D{constructor(t,e=null){super(),this._roadID=0,this._nodeType=0,this._defaultLength=5,this._showLength=50,this._lastNode=e,e&&(e._nextNode=this),this._nodeType=t;let a="sd_suidao01";switch(t){case 0:break;case 1:a="sd_rukou01",this._defaultLength=36.172;break;case 2:a="sd_rukou02",this._defaultLength=36.172;break;case 3:a="sd_suidao02";break;case 4:a="sd_suidao02_xiaoyou";break;case 5:a="sd_suidao02_xiaozuo";break;case 6:a="sd_suidao02_you";break;case 7:a="sd_suidao02_zuo"}this.showLength=this._defaultLength,Laya.Sprite3D.load("res/LayaScene_suidao/Conventional/"+a+".lh",Laya.Handler.create(this,this.loadMeshEnd)),this.name=a}loadMeshEnd(t){switch(t.transform.position.toDefault(),t.transform.localPosition.toDefault(),this._meshNode=Laya.Sprite3D.instantiate(t,this),this._meshNode.transform.localScale.setValue(1,1,1),this._meshNode.transform.localPosition.toDefault(),this._nodeType){case 1:case 2:this._meshNode.transform.localPosition.setValue(.31956,-.0073903,0);break;case 4:case 5:case 6:case 7:break;case 3:case 0:this.setSubMaterialAttr(this._meshNode.getChildByName("sd_qiangbi01")),this.setSubMaterialAttr(this._meshNode.getChildByName("sd_qiangbi049")),this.setSubMaterialAttr(this._meshNode.getChildByName("sd_qiangbi051")),this.setSubMaterialAttr(this._meshNode.getChildByName("sd_lumian01-3")),this.setSubMaterialAttr(this._meshNode.getChildByName("sd_lumian01-2"))}this._meshNode.transform.localScale=this._meshNode.transform.localScale,this._meshNode.transform.localPosition=this._meshNode.transform.localPosition,this.loaded&&(this.loaded.run(),this.loaded=null);let e=this._meshNode.getChildByName("sd_lumian01-3");e&&(e.active=3==S.tunnelMgr.laneNums);let a=this._meshNode.getChildByName("sd_lumian01-2");a&&(a.active=2==S.tunnelMgr.laneNums),(e=this._meshNode.getChildByName("sd_rukoudimian01-3"))&&(e.active=3==S.tunnelMgr.laneNums),(a=this._meshNode.getChildByName("sd_rukoudimian01-2"))&&(a.active=2==S.tunnelMgr.laneNums),(e=this._meshNode.getChildByName("sd_rukoudimian02-3"))&&(e.active=3==S.tunnelMgr.laneNums),(a=this._meshNode.getChildByName("sd_rukoudimian02-2"))&&(a.active=2==S.tunnelMgr.laneNums);let s=this._meshNode.getChildByName("view");s&&(s.active=!1)}get showLength(){return this._showLength}set showLength(t){this._showLength=t;let e=t/this._defaultLength;this.transform.localScale.z=e,this.transform.localScale=this.transform.localScale;let a=-t/2;this._lastNode?a+=this._lastNode.getNextNodePos():a=3==this._nodeType?-t/2+35:t/2,this.transform.localPosition.z=a,0!=this._roadID&&(this.transform.localPosition.x=-50*this._roadID),this.transform.localPosition=this.transform.localPosition}getNextNodePos(){return this.transform.localPosition.z-this._showLength/2}setSubMaterialAttr(t){if(t){if(t instanceof Laya.MeshSprite3D){t.meshRenderer.material.tilingOffsetX=this._showLength/this._defaultLength}for(let e=0;e<t.numChildren;++e)this.setSubMaterialAttr(t.getChildAt(e))}}}class a extends Laya.Script3D{constructor(){super(),this._albedoColor=new Laya.Vector4(.6,.6,.6,1),this._defaultX=7,this._camerOffsetHeight=5,this._camerOffsetDis=10,this._camerLookHeight=0}changeData(t){}onAwake(){if(this.nodeSprite=this.owner.parent,1e4==this._defaultX)return;let t=0;if(this.nodeSprite.DeviceData){switch(this.nodeSprite.DeviceData.orientationLocation){case 18:case 16:case 17:case 0:t=-this._defaultX;break;case 10:case 12:case 13:case 14:case 15:t=this._defaultX;break;case 1:case 2:case 3:t=this.nodeSprite.tunnelSprite.getRoadPosX(this.nodeSprite.DeviceData.orientationLocation)}switch(this.nodeSprite.DeviceData.orientationLocation){case 0:case 10:case 12:case 13:case 14:case 15:case 16:case 18:case 17:1==this.nodeSprite.tunnelSprite.posType&&(t=-t),t<0&&this.nodeSprite.transform.rotate(new Laya.Vector3(0,180,0),!0,!1)}}0!=t&&(this.nodeSprite.transform.localPosition.x=t,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition)}onMouseClick(){S.tunnelMgr.isClickBtn()||this.cameraMoveToLook()}cameraMoveToLook(t=!0){null==S.tunnelMgr.getSelectDevice()&&S.CameraScript.clickViewBack();let e=a.TEMP_CAMERA_POS;this.nodeSprite.transform.getForward(e),e.x*=-this._camerOffsetDis,e.y*=this._camerOffsetDis,e.z*=-this._camerOffsetDis,e.y+=this._camerOffsetHeight,Laya.Vector3.add(this.nodeSprite.transform.position,e,e),this.nodeSprite.transform.position.cloneTo(S.CameraScript.curLookPos),S.CameraScript.curLookPos.y+=this._camerLookHeight,S.CameraScript.tweenMoveTo(e,500,null,S.CameraScript.curLookPos),S.tunnelMgr.setSelectDevice(this.nodeSprite,t)}onUpdate(){}onMouseEnter(){this.showSelectEffect(!0)}onMouseOut(){this.showSelectEffect(!1)}showSelectEffect(t){t?this.setSubMaterialAttr(this.owner,"albedoColor",this._albedoColor):this.setSubMaterialAttr(this.owner,"albedoColor")}setSubMaterialAttr(t,e,a=null,s=null){if(s||(s=e+"_back"),t instanceof Laya.MeshSprite3D){let i=t.meshRenderer.material;i[s]||(i[s]=i[e]),i[e]=a||i[s]}for(let i=0;i<t.numChildren;++i)this.setSubMaterialAttr(t.getChildAt(i),e,a,s)}}a.TEMP_CAMERA_POS=new Laya.Vector3(0,1,0);class s extends a{constructor(){super(),this._lastShowTime=0}onAwake(){switch(this._camerOffsetDis=5,this._camerOffsetHeight=0,this.nodeSprite=this.owner.parent,this.nodeSprite.deviceType){case t.DEVICE_TYPE_ALERTOR:this._camerOffsetDis=8,this._defaultX=7.4;break;case t.DEVICE_TYPE_PHONE:this._defaultX=7.2;break;case t.DEVICE_TYPE_BROADCAST:this._defaultX=6.2;break;case t.DEVICE_TYPE_CAM:this._defaultX=6.17,17==this.nodeSprite.DeviceData.orientationLocation&&(this._defaultX=10)}super.onAwake()}onStart(){let e=0;switch(this.nodeSprite.deviceType){case t.DEVICE_TYPE_ALERTOR:e=2.2;break;case t.DEVICE_TYPE_PHONE:e=1.45;break;case t.DEVICE_TYPE_BROADCAST:e=3.4;break;case t.DEVICE_TYPE_CAM:if(e=4.96,17==this.nodeSprite.DeviceData.orientationLocation){e=3;let t=this.owner;t.transform.localPosition.z=-4,t.transform.localPosition=t.transform.localPosition}}this.nodeSprite.transform.localPosition.y=e,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,17!=this.nodeSprite.DeviceData.orientationLocation&&this.nodeSprite.transform.rotate(new Laya.Vector3(0,-90,0),!0,!1),this.changeData()}onUpdate(){if(super.onUpdate(),this.nodeSprite.deviceType!=t.DEVICE_TYPE_ALERTOR)return;if(1!=this.nodeSprite.DeviceData.workMode)return;let e=Date.now();if(e-this._lastShowTime<400)return;this._lastShowTime=e;let a=this.owner.getChildByName("sd_huozhaijingbao01_jingbaodeng");a&&(a.active=!a.active)}changeAlertor(){let t=this.owner.getChildByName("sd_huozhaijingbao01_jingbaodeng");t&&(t.active=1==this.nodeSprite.DeviceData.workMode);let e=this.owner.getChildByName("Light");e&&(e.active=1==this.nodeSprite.DeviceData.workMode)}changePhone(){let t=this.owner.getChildByName("Light");t&&(t.active=1==this.nodeSprite.DeviceData.workMode);let e=this.owner.getChildByName("lvdeng");e&&(e.active=1==this.nodeSprite.DeviceData.workMode)}changeData(){switch(this.nodeSprite.deviceType){case t.DEVICE_TYPE_ALERTOR:this.changeAlertor();break;case t.DEVICE_TYPE_PHONE:this.changePhone();break;case t.DEVICE_TYPE_BROADCAST:let e=this.owner.getChildByName("pfx");e&&(e.active=1==this.nodeSprite.DeviceData.workMode)}}}class i{static createText3D(t,e=50,a="rgb(240,0,0)",s="宋体"){let i=t.split(/[\n]/),o=0,n=i.length;i.forEach(t=>{let a=t.replace(/[\u0391-\uFFE5]/g,"aa").length/2*(e+2);o=Math.max(a,o)});let r=o;r=Math.max(r,3*e);let h=Laya.Browser.createElement("canvas");var l=h.getContext("2d");h.width=r,h.height=e*n+4,l.fillStyle=a,l.font="bold "+e+"px "+s,l.textAlign="left",l.textBaseline="top";for(let t=0;t<n;++t)l.fillText(i[t],0,t*e+4);let c=new Laya.Texture2D(128,128);return c.loadImageSource(h),Laya.Browser.removeElement(h),c}}class o extends a{constructor(){super()}onStart(){this.meshsp=this.owner,this.meshsp.transform.localPosition.y=.3;let t=this.meshsp.parent;if(this.nodeSprite.showData)this.nodeSprite.DeviceData?(t.transform.localScale.setValue(2,2,2),t.transform.localScale=t.transform.localScale):this.meshsp.transform.localScale=new Laya.Vector3(1,1,.35),this.setText(this.nodeSprite.showData,"宋体");else{let e=-this.meshsp.parent.transform.localPosition.z;e=this.nodeSprite.tunnelSprite.startMark+Math.ceil(e/S.SHOW_SCALE);let a="K"+Math.floor(e/1e3)+"+"+e%1e3;this.setText(a,"宋体"),this.meshsp.transform.localPosition.y=-.5,t.transform.localPosition.x=-15,t.transform.localScale.setValue(2,2,2),t.transform.localScale=t.transform.localScale,t.transform.localPosition=t.transform.localPosition}this.meshsp.transform.localPosition=this.meshsp.transform.localPosition,1==this.nodeSprite.tunnelSprite.posType&&this.meshsp.transform.rotate(new Laya.Vector3(0,180,0),!0,!1)}setText(t,e){let a=i.createText3D(t,50,"rgb(240,240,240)",e);this.meshsp.meshRenderer.material.texture=a}}class n extends a{constructor(){super(),this._tempColor=new Laya.Vector4(1,0,0,1),this._rotateType=0}onStart(){super.onStart(),this._camerOffsetHeight=.5,this._fengshanMesh=this.owner.getChildByName("sd_wj_sd_fengji01_02"),this.nodeSprite.transform.localPosition.y=6.5,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,this._rotateType=2,this.updateState()}onUpdate(){if(super.onUpdate(),this._fengshanMesh)switch(this._rotateType){case 1:this._fengshanMesh.transform.rotate(n.ROTATE_TYPE_VALUE_1);break;case 2:this._fengshanMesh.transform.rotate(n.ROTATE_TYPE_VALUE_2)}}updateState(){this._rotateType=this.nodeSprite.DeviceData.workMode}changeData(t){super.changeData(t),this.updateState()}}n.ROTATE_TYPE_VALUE_1=new Laya.Vector3(0,.1,0),n.ROTATE_TYPE_VALUE_2=new Laya.Vector3(0,-.1,0);class r extends a{constructor(){super()}onAwake(){this._defaultX=7,super.onAwake()}onStart(){this._camerOffsetDis=5,this._camerOffsetHeight=0,this.nodeSprite.transform.localPosition.x=-14.359,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition}}class h extends a{constructor(){super(),this._imgList=new Array("sd_jinzhi02","sd_zhengxiang01","sd_jinzhi02","sd_zuozhuan01"),this._imgList2=new Array("sd_jinzhi01","sd_zhengxiang02","sd_jinzhi011","sd_zuozhuan02")}onAwake(){super.onAwake()}onStart(){super.onStart(),this._camerOffsetDis=5,this._camerOffsetHeight=0,this.nodeSprite.transform.localPosition.y=7,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,1==this.nodeSprite.tunnelSprite.posType&&this.nodeSprite.transform.rotate(new Laya.Vector3(0,180,0),!0,!1),this.changeData()}changeData(){let t=this.owner;for(let e=0;e<this._imgList.length;++e){let a=t.getChildByName(this._imgList[e]);a&&(a.active=!1);let s=t.getChildByName(this._imgList2[e]);s&&(s.active=!1)}let e=t.getChildByName(this._imgList[this.nodeSprite.DeviceData.workMode]);e&&(e.active=!0),2==this.nodeSprite.DeviceData.workMode?(e=t.getChildByName(this._imgList2[1])).active=!0:(e=t.getChildByName(this._imgList2[0])).active=!0}}class l extends a{constructor(){super()}onAwake(){this.nodeSprite=this.owner.parent,this.nodeSprite.deviceType==t.DEVICE_TYPE_LIGHT_ROAD?this._defaultX=1e4:(this._defaultX=4,17==this.nodeSprite.DeviceData.orientationLocation&&(this._defaultX=14)),super.onAwake()}onStart(){if(super.onStart(),this._camerOffsetDis=5,this._camerOffsetHeight=0,this.nodeSprite.deviceType==t.DEVICE_TYPE_LIGHT_ROAD)this._camerOffsetDis=12,this._camerOffsetHeight=12,this.nodeSprite.transform.localPosition.y=5.253753,this.nodeSprite.transform.localPosition.x=.73;else if(this.nodeSprite.transform.localPosition.y=7,17!=this.nodeSprite.DeviceData.orientationLocation)this.nodeSprite.transform.rotate(new Laya.Vector3(0,-90,0),!0,!1);else{this.nodeSprite.transform.localPosition.y=3;let t=this.owner;t.transform.localPosition.z=-4,t.transform.localPosition=t.transform.localPosition}this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,this.changeData()}setOpen(t){let e=this.owner,a=e.getChildByName("sd_dadeng02");if(a){a.getChildAt(0).active=t;let e=a.meshRenderer.material;e.colorA=t?1:.1}e.getChildByName("Light_01")&&(e.getChildAt(0).active=t,e.getChildAt(1).active=t)}changeData(){this.setOpen(1==this.nodeSprite.DeviceData.workMode)}}class c extends a{constructor(){super()}onAwake(){this.nodeSprite=this.owner.parent,this._defaultX=6.8,17==this.nodeSprite.DeviceData.orientationLocation&&(this._defaultX=16),super.onAwake()}onStart(){if(this._camerOffsetDis=5,this._camerOffsetHeight=0,this.nodeSprite.transform.localPosition.y=3.2,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,17!=this.nodeSprite.DeviceData.orientationLocation)this.nodeSprite.transform.rotate(new Laya.Vector3(0,-90,0),!0,!1);else{let t=this.owner;t.transform.localPosition.z=-4,t.transform.localPosition=t.transform.localPosition}this.changeData()}setOpen(t){let e=this.owner;for(let a=0;a<6;a++){let s=e.getChildAt(a),i=s.getChildAt(0),o=s.getChildAt(1);i.active=t,o.active=!t}}changeData(){this.setOpen(1==this.nodeSprite.DeviceData.workMode)}}class d extends a{constructor(){super()}onStart(){super.onAwake(),this._camerOffsetHeight=15,this._camerLookHeight=4;let e=1==this.nodeSprite.tunnelSprite.posType;if(this.nodeSprite.deviceType==t.DEVICE_TYPE_QB_BOARD_F)this.nodeSprite.transform.localPosition.x=8.6,this.showText(this.nodeSprite.DeviceData.contentText,50),e&&(this.nodeSprite.transform.localPosition.x=7.6);else{let t=this.owner;t.transform.localPosition.y=7.63,t.transform.localPosition=t.transform.localPosition,this.nodeSprite.transform.localPosition.x=0,this.showText(this.nodeSprite.DeviceData.contentText,50)}e&&(this.nodeSprite.transform.localPosition.x=-this.nodeSprite.transform.localPosition.x,this.nodeSprite.transform.rotate(new Laya.Vector3(0,180,0),!0,!1)),this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition}showText(t,e){let a=this.owner.getChildByName("textinput");if(!t||""==t)return void(a.active=!1);a.active=!0;let s=a.getComponent(Laya.Animator),o=i.createText3D(t,50,"rgb(250,0,0)","Microsoft YaHei");if(a.meshRenderer.material.texture=o,s){let e=t.replace(/[\u0391-\uFFE5]/g,"aa").length;s.speed=10/e}}}class m extends a{constructor(){super(),this._imgs=new Array("sd_jiaotongtubiao03","sd_jiaotongtubiao01","sd_jiaotongtubiao02","sd_zuozhuandeng001")}onAwake(){this._defaultX=1e4,super.onAwake()}onStart(){super.onStart(),this._camerOffsetHeight=15,this._camerLookHeight=6,this.nodeSprite.transform.localPosition.x=-7.2,1==this.nodeSprite.tunnelSprite.posType&&(this.nodeSprite.transform.localPosition.x=8.5,this.nodeSprite.transform.rotate(new Laya.Vector3(0,180,0),!0,!1)),this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,this.changeData()}changeData(){let t=this.owner;for(let e=0;e<this._imgs.length;++e){t.getChildByName(this._imgs[e]).active=this.nodeSprite.DeviceData.workMode==e}}}class _ extends a{constructor(){super()}onAwake(){this._defaultX=6.8,super.onAwake()}onStart(){this._camerOffsetDis=7,this._camerOffsetHeight=2;let t=this.owner;t.transform.localPosition.x=4.65,this.nodeSprite.transform.localPosition.x>0&&(t.transform.localPosition.x=-.36),t.transform.localPosition=t.transform.localPosition,this.nodeSprite.transform.localPosition.y=2.3,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,this.nodeSprite.transform.rotate(new Laya.Vector3(0,-90,0),!0,!1),this.changeData()}changeData(){let t=this.owner.getChildByName("sd_juanzhamen01");t.transform.localPositionY=1.564;let e=1;switch(this.nodeSprite.DeviceData.workMode){case 0:t.active=!0,e=.6,t.transform.localPositionY=2.2;break;case 1:e=1;break;case 2:e=.001}let a=t.transform;a.localScaleZ!=e&&Laya.Tween.to(a,{localScaleZ:e,update:new Laya.Handler(this,function(){a.localScale=a.localScale})},2e3),t.transform.localPosition=t.transform.localPosition}}class u extends a{constructor(){super()}onAwake(){this._defaultX=6.77,super.onAwake()}onStart(){this._camerOffsetDis=-5,this._camerOffsetHeight=0,this.nodeSprite.transform.localPosition.y=7.188,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,this.nodeSprite.transform.rotate(new Laya.Vector3(91,0,0),!0,!1),this.changeData()}changeData(){this.nodeSprite.DeviceData.contentText,this.showText(this.nodeSprite.DeviceData.contentText,30),this.showName(this.nodeSprite.DeviceData.deviceName)}showText(t,e){let a=this.owner.getChildByName("text");if(!t||""==t)return void(a.active=!1);a.active=!0;let s=i.createText3D(t,50,"rgb(250,0,0)","Microsoft YaHei");a.meshRenderer.material.texture=s,1==t.split(/[\n]/).length?a.transform.localScaleZ=.03529655:a.transform.localScaleZ=.0705931,a.transform.localScale=a.transform.localScale}showName(t){let e=this.owner.getChildByName("name");if(!t||""==t)return void(e.active=!1);e.active=!0;let a=i.createText3D(t,50,"rgb(200,200,200)","Microsoft YaHei");e.meshRenderer.material.texture=a}}class g extends a{constructor(){super()}onAwake(){this._defaultX=4,super.onAwake()}onStart(){this._camerOffsetDis=5,this._camerOffsetHeight=0,this.nodeSprite.transform.localPosition.y=7,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition,this.nodeSprite.transform.rotate(new Laya.Vector3(0,-90,0),!0,!1),this.changeData()}setOpen(t){let e=this.owner;for(let a=0;a<6;a++){let s=e.getChildAt(a).getChildByName("sd_dadeng02");s.getChildAt(0).active=t;let i=s.meshRenderer.material;i.colorA=t?1:.1}}changeData(){this.setOpen(1==this.nodeSprite.DeviceData.workMode)}}class p extends a{constructor(){super()}onStart(){this._camerOffsetDis=5,this._camerOffsetHeight=0,4==this.nodeSprite.DeviceData.emptyType?this.nodeSprite.transform.localPosition.x=25:this.nodeSprite.transform.localPosition.x=-14.5,this.nodeSprite.transform.localPosition=this.nodeSprite.transform.localPosition}}class f extends Laya.Sprite3D{constructor(e){switch(super(),this._deviceType=e,this._deviceType){case t.DEVICE_TYPE_QB_BOARD:this.loadItem("sd_qingbaoban02");break;case t.DEVICE_TYPE_QB_BOARD_F:this.loadItem("sd_qingbaoban01");break;case t.DEVICE_TYPE_DRAUGHT:this.loadItem("sd_wj_sd_fengji01");break;case t.DEVICE_TYPE_DRAUGHT2:this.loadItem("sd_fengji02");break;case t.DEVICE_TYPE_LIGHT01:this.loadItem("sd_dadeng01");break;case t.DEVICE_TYPE_LIGHT_ROAD:this.loadItem("ludeng01");break;case t.DEVICE_TYPE_TEXT_DIS:this.loadItem("textdis");break;case t.DEVICE_TYPE_ALERTOR:this.loadItem("sd_huozhaijingbao01");break;case t.DEVICE_TYPE_PHONE:this.loadItem("sd_dianhua01");break;case t.DEVICE_TYPE_BROADCAST:this.loadItem("sd_guangbo01");break;case t.DEVICE_TYPE_LIGHT_GRUOP:this.loadItem("dengzu01");break;case t.DEVICE_TYPE_LIGHT_GRUOP2:this.loadItem("dengzu02");break;case t.DEVICE_TYPE_SIGNAL_LAMP:this.loadItem("sd_jiaotongxinhaodeng01");break;case t.DEVICE_TYPE_LAMP_INDICATOR:this.loadItem("sd_daoluzhishideng01");break;case t.DEVICE_TYPE_HENGDONG1:this.loadItem("sd_hengdao02");break;case t.DEVICE_TYPE_HENGDONG2:this.loadItem("sd_hengdao01");break;case t.DEVICE_TYPE_DOOR:this.loadItem("suidaomen01");break;case t.DEVICE_TYPE_CAM:this.loadItem("sd_shexiangtou01");break;case t.DEVICE_TYPE_SENSOR:this.loadItem("chuangganqi01");break;case t.DEVICE_TYPE_JIFANG1:this.loadItem("sd_jifang")}}loadItem(t){Laya.Sprite3D.load("res/LayaScene_suidao/Conventional/"+t+".lh",Laya.Handler.create(this,this.loadMeshEnd)),this.name=t}get tunnelSprite(){return this.parent}get deviceType(){return this._deviceType}getDeviceScirpt(){let t=this.getChildAt(0);return t?t.getComponent(a):null}loadMeshEnd(e,a=!1){let i=e;switch(a?this.addChild(e):(e.transform.position.toDefault(),e.transform.localPosition.toDefault(),(i=Laya.Sprite3D.instantiate(e,this)).transform.localPosition.toDefault(),i.transform.localPosition=i.transform.localPosition),this._deviceType){case t.DEVICE_TYPE_QB_BOARD_F:case t.DEVICE_TYPE_QB_BOARD:i.addComponent(d);break;case t.DEVICE_TYPE_DRAUGHT2:case t.DEVICE_TYPE_DRAUGHT:i.addComponent(n);break;case t.DEVICE_TYPE_LIGHT_ROAD:case t.DEVICE_TYPE_LIGHT01:i.addComponent(l);break;case t.DEVICE_TYPE_TEXT_DIS:i.addComponent(o);break;case t.DEVICE_TYPE_CAM:case t.DEVICE_TYPE_ALERTOR:case t.DEVICE_TYPE_PHONE:case t.DEVICE_TYPE_BROADCAST:i.addComponent(s);break;case t.DEVICE_TYPE_LIGHT_GRUOP:i.addComponent(c);break;case t.DEVICE_TYPE_LIGHT_GRUOP2:i.addComponent(g);break;case t.DEVICE_TYPE_SIGNAL_LAMP:i.addComponent(m);break;case t.DEVICE_TYPE_LAMP_INDICATOR:i.addComponent(h);break;case t.DEVICE_TYPE_HENGDONG1:case t.DEVICE_TYPE_HENGDONG2:i.addComponent(r);break;case t.DEVICE_TYPE_DOOR:i.addComponent(_);break;case t.DEVICE_TYPE_SENSOR:i.addComponent(u);break;case t.DEVICE_TYPE_JIFANG1:i.addComponent(p)}}get DeviceData(){return this._deviceData}changeData(t){this._deviceData=t;let e=this.getDeviceScirpt();e&&e.changeData(t)}get showData(){return this._showData}changeShowData(t){this._showData=t;let e=this.getDeviceScirpt();e&&e.changeData(t)}}class E extends Laya.Sprite3D{constructor(){super(),this.TunnelLength=200,this._posType=0,this.RoadCount=3,this._nodeList=new Array,this._bActive=!0,this._startMark=0,this._disText="方向显示"}get posType(){return this._posType}set startMark(t){this._startMark=t}get startMark(){return this._startMark}getRoadPosX(t){let e=0;switch(t){case 1:e=-3.7,2==S.tunnelMgr.laneNums&&(e=-2.7);break;case 2:2==S.tunnelMgr.laneNums&&(e=2.7);break;case 3:e=3.8}return 1==this.posType&&(e=-e),e}init(e,a,s){if(this.TunnelLength=e,this._posType=a,s||(s=[]),this.name="TunnelSprite"+this._posType,0==a){let e=Math.floor(S.tunnelMgr.getMaxLenth()/50)+2;for(let a=0;a<e;++a){this.addChild(new f(t.DEVICE_TYPE_TEXT_DIS)).transform.localPosition.z=(50-50*a)*S.SHOW_SCALE}}this._bActive?this.loadRoad(s):this.loadKongDong(),this.transform.localPosition.x=a*-E.POS_OFFSET_VALUE,this.transform.localPosition=this.transform.localPosition}loadKongDong(){let t=new e(3,null);t.showLength=S.tunnelMgr.getMaxLenth()*S.SHOW_SCALE+72,this.addChild(t),this._nodeList.push(t)}loadRoad(a){let s=[];for(let e=0;e<a.length;++e){let i={data:a[e],pos:(a[e].pileNumber-this.startMark)*S.SHOW_SCALE};if(i.data.leftRightFlag=parseInt(i.data.leftRightFlag),i.data.leftRightFlag==this._posType+1||3==i.data.leftRightFlag||0!=i.data.emptyType)if(i.data.emptyType<3)s.push(i);else if(0==this._posType){let e=this.addChild(new f(t.DEVICE_TYPE_JIFANG1));e.changeData(i.data),e.transform.localPosition.z=-(i.data.pileNumber-this.startMark)*S.SHOW_SCALE}}s.sort(function(t,e){return t.pos-e.pos});let i=new e(1);this.addChild(i),this._nodeList.push(i);let o=i,n=0;for(let a=0;a<s.length;++a){if(n<s[a].pos){let t=new e(0,o);t.showLength=s[a].pos-n,this.addChild(t),this._nodeList.push(t),o=t,n=s[a].pos}let i=0,r=5,h=0;switch(s[a].data.emptyType){case 0:i=3,r=s[a].data.length*S.SHOW_SCALE;break;case 1:i=0==this.posType?4:5,h=t.DEVICE_TYPE_HENGDONG1;break;case 2:i=0==this.posType?6:7,h=t.DEVICE_TYPE_HENGDONG2}if(0==this.posType&&0!=h){let t=this.addChild(new f(h));t.changeData(s[a].data),t.transform.localPosition.z=o.getNextNodePos()-r/2}let l=new e(i,o);l.showLength=r,l.addData=s[a].data,this.addChild(l),this._nodeList.push(l),o=l,n+=l.showLength}if(n<this.TunnelLength){let t=new e(0,o);t.showLength=this.TunnelLength-n,this.addChild(t),this._nodeList.push(t),o=t}let r=new e(2,o);this.addChild(r),this._nodeList.push(r)}addDevice(e){if(!this._bActive)return;let a=e.pileNumber-this.startMark;a>0&&a>-this.TunnelLength&&(a*=S.SHOW_SCALE);let s=0;switch(e.deviceTypeCode){case"signallamp":s=t.DEVICE_TYPE_SIGNAL_LAMP;break;case"laneIndicator":s=t.DEVICE_TYPE_LAMP_INDICATOR;break;case"urgentphone":s=t.DEVICE_TYPE_PHONE;break;case"controller":break;case"broadcast":s=t.DEVICE_TYPE_BROADCAST;break;case"conflagration":s=t.DEVICE_TYPE_ALERTOR;break;case"guidelight":break;case"lighting":try{if(e.deviceConfig){switch(JSON.parse(e.deviceConfig).deviceSubtypeCode){case"R":s=t.DEVICE_TYPE_LIGHT_ROAD;break;case"T":s=t.DEVICE_TYPE_LIGHT01}}else s=t.DEVICE_TYPE_LIGHT01}catch(e){s=t.DEVICE_TYPE_LIGHT01}break;case"lightingloop":s=t.DEVICE_TYPE_LIGHT_GRUOP2;break;case"waterlevel":case"electronicfence":case"environment":break;case"tunneldoor":s=t.DEVICE_TYPE_DOOR;break;case"draughtfan":try{switch(JSON.parse(e.deviceConfig).deviceSubtypeCode){case"Z":s=t.DEVICE_TYPE_DRAUGHT;break;case"S":s=t.DEVICE_TYPE_DRAUGHT2}}catch(e){s=t.DEVICE_TYPE_DRAUGHT2}break;case"camera":case"eventcamera":s=t.DEVICE_TYPE_CAM;break;case"vi":case"winddirection":case"co":case"windspeed":case"temperature":case"luminometer":case"ammeter":s=t.DEVICE_TYPE_SENSOR;break;case"intelligenceboard":try{switch(JSON.parse(e.deviceConfig).deviceSubtypeCode){case"M":s=t.DEVICE_TYPE_QB_BOARD;break;case"F":s=t.DEVICE_TYPE_QB_BOARD_F}}catch(e){s=t.DEVICE_TYPE_QB_BOARD}}if(0==s)return null;let i=this.addChild(new f(s));return i.changeData(e),i.transform.localPosition.z=-a,i}setDirText(e){if(!this._bActive)return;this._disText=e+"->->";let a=this.addChild(new f(t.DEVICE_TYPE_TEXT_DIS));a.changeShowData(this._disText),0==this._posType?a.transform.localPosition.setValue(14,-1,16):a.transform.localPosition.setValue(-14,-1,16),a.transform.localPosition=a.transform.localPosition;let s=this.addChild(new f(t.DEVICE_TYPE_TEXT_DIS));s.changeShowData(this._disText),0==this._posType?s.transform.localPosition.setValue(14,-1,16-this.TunnelLength-40):s.transform.localPosition.setValue(-14,-1,16-this.TunnelLength-40),s.transform.localPosition=s.transform.localPosition;let i=Math.floor(this.TunnelLength/250)+1;for(let e=1;e<=this.RoadCount;++e)for(let a=1;a<i;++a){let s=this.addChild(new f(t.DEVICE_TYPE_TEXT_DIS));s.changeShowData(this._disText),s.changeData(!0),s.transform.localPosition.x=this.getRoadPosX(e),s.transform.localPosition.z=-10-250*a,s.transform.localPosition=s.transform.localPosition}}getStartView(){let t=this._nodeList[0].getChildAt(0);return t&&t.getChildByName("view")}getEndView(){let t=this._nodeList[this._nodeList.length-1].getChildAt(0);return t&&t.getChildByName("view")}}E.POS_OFFSET_VALUE=28.6;class S{}S.SHOW_SCALE=1,S.SHOW_DEBUG=!1,S.tunnelMgr=new class{constructor(){this.TunnelCount=2,this.showMode=0,this.laneNums=2,this._deviceList=new Map,this._maxLength=0,this._minStartPos=0}init(t){Laya.stage.on(Laya.Event.MOUSE_DOWN,this,this.mouseClick),Laya.stage.on(Laya.Event.MOUSE_UP,this,this.mouseClickUp)}mouseClick(t){this._curClickTarget=t.target,this._curClickTarget instanceof C&&(this._clickLastTime=Date.now())}mouseClickUp(){this._curClickTarget=null}isClickBtn(){return Date.now()-this._clickLastTime>500}getMaxLenth(){return this._maxLength}getMinStartPos(){return this._minStartPos}loadTunnel(t,e){t.lengthScale&&(S.SHOW_SCALE=t.lengthScale),t.showMode&&(this.showMode=t.showMode),t.showDebug&&(S.SHOW_DEBUG=1==t.showDebug),this.InitData=t,this.laneNums=t.laneNums,2==t.singleDoubleType?(t.startStakeMarkRight=t.startStakeMark,t.rightHoleLength=t.leftHoleLength):1==t.singleDoubleType&&(t.startStakeMark=t.startStakeMarkRight,t.leftHoleLength=t.rightHoleLength),this._maxLength=Math.max(t.leftHoleLength,t.rightHoleLength),this._minStartPos=Math.min(t.startStakeMark,t.startStakeMarkRight);let a=new E;S.GameScene.addChild(a),3==t.singleDoubleType||2==t.singleDoubleType?a._bActive=!0:a._bActive=!1,a.RoadCount=t.laneNums,a.startMark=t.startStakeMark,a.init(t.leftHoleLength*S.SHOW_SCALE,1,e),a.setDirText(t.leftHoleDirection),a._bActive&&(a.transform.position.z=(t.startStakeMarkRight-t.startStakeMark)*S.SHOW_SCALE),a.transform.position=a.transform.position,this._leftTunnelSprite=a;let s=new E;S.GameScene.addChild(s),3==t.singleDoubleType||1==t.singleDoubleType?s._bActive=!0:s._bActive=!1,s.RoadCount=t.laneNums,s.startMark=t.startStakeMarkRight,s.init(t.rightHoleLength*S.SHOW_SCALE,0,e),s.setDirText(t.rightHoleDirection),this._rightTunnelSprite=s,S.CameraScript&&(S.CameraScript._minViewZ=-this.getMaxLenth())}findDevice(t){return this._deviceList[t]}addDevice(t){let e=this.findDevice(t.id);e?e.changeData(t):(17==t.orientationLocation&&(t.leftRightFlag=2),e=1==t.leftRightFlag?this._rightTunnelSprite.addDevice(t):this._leftTunnelSprite.addDevice(t),this._deviceList[t.id]=e)}addDevices(t){for(let e=0;e<t.length;++e)this.addDevice(t[e])}getCurView(t){if(!this._viewList){let t=this._rightTunnelSprite.getStartView(),e=this._leftTunnelSprite.getEndView();if(!t&&!e)return void console.log("资源还没加载结束，不能巡游");this._viewList=new Array,t&&(this._viewList.push(t),this._viewList.push(this._rightTunnelSprite.getEndView())),e&&(this._viewList.push(e),this._viewList.push(this._leftTunnelSprite.getStartView()))}return this._viewList.length<=t?null:this._viewList[t]}setSelectDevice(t,e=!0){if(this._curSelectDevice==t&&null==t)return;if(this._curSelectDevice=t,C.instance.setMoveBtnState(null==t),!t)return void(C.instance.textSelect.text="当前选中：无");let a=t.name;if(e&&t.DeviceData){a=JSON.stringify(t.DeviceData);let e={msgType:"clickDevice",msgData:t.DeviceData};Laya.Browser.window.parent.postMessage(e)}C.instance.textSelect.text="当前选中："+a}getSelectDevice(){return this._curSelectDevice}};var D,w=Laya.Scene,L=Laya.ClassUtils.regClass;!function(t){!function(t){class e extends w{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("test/TestScene")}}t.TestSceneUI=e,L("ui.test.TestSceneUI",e)}(t.test||(t.test={}))}(D||(D={}));class C extends D.test.TestSceneUI{constructor(){super(),this._defBtnClolor="#5391F3,#C1D9FF,#C1D9FF,#5391F3",C.instance=this,this.btnReset.on(Laya.Event.CLICK,this,this.onClickReset),this.btnAutoView.on(Laya.Event.CLICK,this,this.onClickAutoView),this.btnTopView.labelColors=this._defBtnClolor,this.btnRightHole.labelColors=this._defBtnClolor,this.btnLeftHole.labelColors=this._defBtnClolor,this.btnRightIn.labelColors=this._defBtnClolor,this.btnLeftIn.labelColors=this._defBtnClolor,this.btnReset.labelColors=this._defBtnClolor,this.btnAutoView.labelColors=this._defBtnClolor,this.btnEasy.labelColors=this._defBtnClolor,this.btnTopView.on(Laya.Event.CLICK,this,function(){S.CameraScript.moveToTopView()}),this.btnRightHole.on(Laya.Event.CLICK,this,function(){S.CameraScript.moveToRightHole()}),this.btnLeftHole.on(Laya.Event.CLICK,this,function(){S.CameraScript.moveToLeftHole()}),this.btnRightIn.on(Laya.Event.CLICK,this,function(){S.CameraScript.moveToRightIn()}),this.btnLeftIn.on(Laya.Event.CLICK,this,function(){S.CameraScript.moveToLeftIn()}),this.btnMoveLeft.on(Laya.Event.MOUSE_DOWN,this,function(){S.CameraScript.btnMoveValue=3}),this.btnMoveRight.on(Laya.Event.MOUSE_DOWN,this,function(){S.CameraScript.btnMoveValue=-3}),this.btnMoveLeft.on(Laya.Event.MOUSE_UP,this,function(){S.CameraScript.btnMoveValue=0}),this.btnMoveRight.on(Laya.Event.MOUSE_UP,this,function(){S.CameraScript.btnMoveValue=0}),this.btnEasy.on(Laya.Event.CLICK,this,function(){S.CameraScript.easyMode=!S.CameraScript.easyMode,this.btnEasy.label=S.CameraScript.easyMode?"锁定模式":"自由模式"});let t=S.tunnelMgr.getMinStartPos(),e=S.tunnelMgr.getMaxLenth(),a=Math.ceil(e/1e3)+1;if(1==a||1!=S.tunnelMgr.showMode)this.listPos.repeatX=0,this.listPos.visible=!1;else{this.listPos.repeatX=a;let s=[];for(let i=0;i<a;++i){let o=1e3*i-20;o>e&&(o=e);let n=t+o,r=(o*=S.SHOW_SCALE)+1e3*S.SHOW_SCALE;0==i?s.push([o,"K"+Math.floor(n/1e3)+"(起点)",r]):i==a-1?s.push([o,"K"+Math.floor(n/1e3)+"(终点)",r]):s.push([o,"K"+Math.floor(n/1e3),r])}this.setPosList(s)}this.resizeEvt(),Laya.stage.on(Laya.Event.RESIZE,this,this.resizeEvt),this.imgShowInfo.visible=S.SHOW_DEBUG}resizeEvt(){this.width=Laya.Browser.width,this.height=Laya.Browser.height}setMoveBtnState(t){this.btnMoveLeft.disabled=this.btnMoveRight.disabled=!t}setPosList(t){this.listPos.array=t,this.listPos.renderHandler=new Laya.Handler(this,function(t,e){let a=t.getChildAt(0);a.labelColors=this._defBtnClolor,a.label=this.listPos.array[e][1]}),this.listPos.mouseHandler=new Laya.Handler(this,function(t,e){if(Laya.Event.CLICK!=t.type)return;let a=this.listPos.array[e];S.CameraScript.moveZ(-a[0]-S.CameraScript.transform.position.z,500)})}onClickReset(){S.CameraScript.reset()}onClickAutoView(){S.CameraScript.autoView(!S.CameraScript.autoStat)}updateViewShow(){S.CameraScript.autoStat?this.btnAutoView.label="停止巡游":S.CameraScript.stopBackView?this.btnAutoView.label="继续巡游":this.btnAutoView.label="自动巡游"}onChangeLenth(t){}setShowPos(t){if(this.listPos.visible)for(let e=0;e<this.listPos.cells.length;++e){let a=this.listPos.array[e],s=this.listPos.cells[e].getChildAt(0);(t=Math.ceil(t))>=a[0]&&t<a[2]?s.selected=!0:s.selected=!1}}}class y{constructor(){}static init(){(0,Laya.ClassUtils.regClass)("script/GameUI.ts",C)}}y.width=1920,y.height=1080,y.scaleMode="full",y.screenMode="horizontal",y.alignV="middle",y.alignH="center",y.startScene="test/TestScene.scene",y.sceneRoot="",y.debug=!1,y.stat=!1,y.physicsDebug=!1,y.exportSceneToJson=!0,y.init();class T extends Laya.Script3D{constructor(){super(),this._initCamerPos=new Laya.Vector3,this._initCamerDir=new Laya.Quaternion,this._moveing=!1,this.curLookPos=new Laya.Vector3,this.autoViewIndex=0,this.autoStat=!1,this._tempMoveTarget=new Laya.Vector3,this._clickBackPos=new Laya.Vector3,this._clickBackLook=new Laya.Vector3,this._maxViewZ=35,this._minViewZ=0}initTransform(t=!1){}reset(){S.tunnelMgr.setSelectDevice(null),this.curLookPos.setValue(0,0,0),this.tweenMoveTo(this._initCamerPos,500,this._initCamerDir)}clickViewBack(){this.camera.transform.position.cloneTo(this._clickBackPos),this.curLookPos.cloneTo(this._clickBackLook)}clickViewReset(){this._clickBackLook.cloneTo(this.curLookPos),this.tweenMoveTo(this._clickBackPos,100,null,this.curLookPos)}onAwake(){this.camera=this.owner}onStart(){this.camera.transform.position.cloneTo(this._initCamerPos),this.camera.transform.rotation.cloneTo(this._initCamerDir)}tweenMoveTo(t,e,a=null,s=null,i=null,o=!1){i||this.stopView();let n=this.camera.transform.position;if(this._moveing=!0,Laya.Tween.clearAll(n),Laya.Tween.to(n,{x:t.x,y:t.y,z:t.z,update:new Laya.Handler(this,function(){this.camera.transform.position=n,s&&this.camera.transform.lookAt(s,o?T.UP_V3_2:T.UP_V3,!1)})},e,null,Laya.Handler.create(this,function(){this.moveOver(),i&&i()})),!s&&a){let t=this.camera.transform.rotation;Laya.Tween.clearAll(t),Laya.Tween.to(t,{x:a.x,y:a.y,z:a.z,w:a.w,update:new Laya.Handler(this,function(){this.camera.transform.rotation=t})},e)}}moveOver(){Laya.Tween.clearAll(this.camera.transform.position),this._moveing=!1}onUpdate(){C.instance&&C.instance.setShowPos(-this.camera.transform.position.z)}stopView(){if(!this.autoStat)return;this.autoStat=!1,this.stopBackView||(this.stopBackView=new Laya.Vector3),this.camera.transform.position.cloneTo(this.stopBackView),this.moveOver(),C.instance.updateViewShow();let t={msgType:"autoViewEvt",msgData:this.autoStat};Laya.Browser.window.parent.postMessage(t)}autoView(t){if(!t)return void this.stopView();let e=S.tunnelMgr.getCurView(this.autoViewIndex);if(!e)return!1;S.tunnelMgr.setSelectDevice(null);let s=e.transform.position;if(!this.autoStat){this.autoStat=t;let e={msgType:"autoViewEvt",msgData:this.autoStat};Laya.Browser.window.parent.postMessage(e),C.instance.updateViewShow()}this.stopBackView&&(this.camera.transform.position=this.stopBackView,this.stopBackView=null);let i=a.TEMP_CAMERA_POS;i.x=0,i.y=0,i.z=3,i.y+=2,Laya.Vector3.add(s,i,i),s.cloneTo(this.curLookPos),this.curLookPos.y+=2;let o=200*Laya.Vector3.distance(i,S.GameCamera.transform.position);this.autoViewIndex%2==0&&(o=400),this.tweenMoveTo(i,o,null,S.CameraScript.curLookPos,function(){S.CameraScript.autoViewIndex++,S.CameraScript.autoViewIndex>3&&(S.CameraScript.autoViewIndex=0),S.CameraScript.autoView(!0)})}moveToTopView(){S.tunnelMgr.setSelectDevice(null);let t=this._tempMoveTarget;this.camera.transform.position.cloneTo(t),t.z>this._maxViewZ?t.z=this._maxViewZ:t.z<this._minViewZ&&(t.z=this._minViewZ),t.setValue(-15,85,t.z),this.curLookPos.setValue(-15,0,t.z),this.tweenMoveTo(t,300,null,this.curLookPos,null,!0)}moveToRightHole(){S.tunnelMgr.setSelectDevice(null);let t=this._tempMoveTarget;this.camera.transform.position.cloneTo(t),t.z>this._maxViewZ?t.z=this._maxViewZ:t.z<this._minViewZ&&(t.z=this._minViewZ),t.setValue(36,48,t.z),this.curLookPos.setValue(-6,0,t.z),this.tweenMoveTo(t,300,null,this.curLookPos)}moveToLeftHole(){S.tunnelMgr.setSelectDevice(null);let t=this._tempMoveTarget;this.camera.transform.position.cloneTo(t),t.z>this._maxViewZ?t.z=this._maxViewZ:t.z<this._minViewZ&&(t.z=this._minViewZ),t.setValue(-68,47,t.z),this.curLookPos.setValue(-20,0,t.z),this.tweenMoveTo(t,300,null,this.curLookPos)}moveToRightIn(){S.tunnelMgr.setSelectDevice(null);let t=this._tempMoveTarget;this.camera.transform.position.cloneTo(t),t.z>this._maxViewZ?t.z=this._maxViewZ:t.z<this._minViewZ&&(t.z=this._minViewZ),t.setValue(0,2.5,t.z),this.curLookPos.setValue(0,2.5,t.z-5),this.tweenMoveTo(t,300,null,this.curLookPos)}moveToLeftIn(){S.tunnelMgr.setSelectDevice(null);let t=this._tempMoveTarget;this.camera.transform.position.cloneTo(t),t.z>this._maxViewZ?t.z=this._maxViewZ:t.z<this._minViewZ&&(t.z=this._minViewZ),t.setValue(-E.POS_OFFSET_VALUE,2.5,t.z),this.curLookPos.setValue(-E.POS_OFFSET_VALUE,2.5,t.z-5),this.tweenMoveTo(t,300,null,this.curLookPos)}moveZ(t,e=200){let a=this._tempMoveTarget;this.camera.transform.position.cloneTo(a),a.z+=t,this.curLookPos.z+=t,this.tweenMoveTo(a,e)}}T.UP_V3=new Laya.Vector3(0,1,0),T.UP_V3_2=new Laya.Vector3(-1,0,0);var P=Laya.Vector3,v=Laya.Quaternion;class V extends T{constructor(){super(),this.canRotation_X=!0,this.canRotation_Y=!0,this.canScale=!0,this._tempVector3=new Laya.Vector3,this.AroundPos=new P,this.mouseSettings=new M(0,.3,.3),this.angleRange=new k(-360,360),this.distanceRange=new k(1,200),this.damper=5,this.CurrentAngles=new P,this.CurrentAnglesTemp=new P,this.targetAngles=new P,this.moveV3=new Laya.Vector3,this._keydowning=!1,this.yawPitchRoll=new Laya.Vector3,this.rotaionSpeed=8e-5,this.btnMoveValue=0,this.easyMode=!0,this.FORWORD=new P,this.deltaWheel=0,this.lastMouseX=0,this.lastMouseY=0,this.mouseRunning=!1,this.tempRotationZ=new v,this.tempV=new P,this.tempV1=new P}onStart(){super.onStart(),S.CameraScript=this,0==this._minViewZ&&(this._minViewZ=-S.tunnelMgr.getMaxLenth()),this.initTransform(),Laya.stage.on(Laya.Event.MOUSE_DOWN,this,this.mouseDown),Laya.stage.on(Laya.Event.MOUSE_MOVE,this,this.mouseMove),Laya.stage.on(Laya.Event.MOUSE_UP,this,this.mouseUp),Laya.stage.on(Laya.Event.MOUSE_WHEEL,this,this.mouseWheel),Laya.stage.on(Laya.Event.RIGHT_MOUSE_DOWN,this,this.rightMouseDown),Laya.stage.on(Laya.Event.RIGHT_MOUSE_UP,this,this.rightMouseUp),Laya.stage.on(Laya.Event.BLUR,this,this.blurEvent),Laya.stage.on(Laya.Event.MOUSE_OUT,this,this.blurEvent)}blurEvent(){this.mouseRunning=!1,this.bRightMouseDown=!1,S.tunnelMgr.mouseClickUp()}initTransform(t=!1){this.transform=this.camera.transform,this.CurrentAngles.setValue(-this.transform.rotationEuler.x,this.transform.rotationEuler.y,this.transform.rotationEuler.z),this.targetAngles.setValue(-this.transform.rotationEuler.x,this.transform.rotationEuler.y,this.transform.rotationEuler.z),t||(this.curLookPos?this.curLookPos.cloneTo(this.AroundPos):this.AroundPos.setValue(0,0,0)),this.CurrentDistance=P.distance(this.transform.position,this.AroundPos),this.targetDistance=P.distance(this.transform.position,this.AroundPos);let e=this.distanceRange.max,a=30;this.easyMode||null!=S.tunnelMgr.getSelectDevice()||(e=2,a=1),(t||this.CurrentDistance>e)&&(P.scale(this.GetForward,-a,this.tempV),P.subtract(this.transform.position,this.tempV,this.tempV1),this.tempV1.cloneTo(this.AroundPos),this.tempV1.cloneTo(this.curLookPos)),this.CurrentDistance=P.distance(this.transform.position,this.AroundPos),this.targetDistance=P.distance(this.transform.position,this.AroundPos)}moveOver(){super.moveOver(),this.initTransform()}_updateRotation(){Math.abs(this.yawPitchRoll.y)<1.5&&(Laya.Quaternion.createFromYawPitchRoll(this.yawPitchRoll.x,this.yawPitchRoll.y,this.yawPitchRoll.z,this.tempRotationZ),this.tempRotationZ.cloneTo(this.camera.transform.localRotation),this.camera.transform.localRotation=this.camera.transform.localRotation)}onUpdate(){if(super.onUpdate(),this._moveing)return;var t=Laya.timer.delta;if(0!=this.btnMoveValue)return void this.btnClickMoveZ(.01*t*this.btnMoveValue);let e=Laya.KeyBoardManager.hasKeyDown(16)?3:1;if(S.tunnelMgr.getSelectDevice()||(Laya.KeyBoardManager.hasKeyDown(38)&&this.btnClickMoveZ(-.03*t*e),Laya.KeyBoardManager.hasKeyDown(40)&&this.btnClickMoveZ(.03*t*e)),!isNaN(this.lastMouseX)&&!isNaN(this.lastMouseY)&&(S.tunnelMgr.getSelectDevice()||!this.easyMode)){let a=this._keydowning;this._keydowning=!1,Laya.KeyBoardManager.hasKeyDown(87)&&this.moveForward(0,1*e),Laya.KeyBoardManager.hasKeyDown(83)&&this.moveForward(0,-1*e),Laya.KeyBoardManager.hasKeyDown(65)&&this.moveForward(1*e,0),Laya.KeyBoardManager.hasKeyDown(68)&&this.moveForward(-1*e,0),Laya.KeyBoardManager.hasKeyDown(81)&&this.moveVertical(.01*t*e),Laya.KeyBoardManager.hasKeyDown(69)&&this.moveVertical(-.01*t*e),a&&!this._keydowning&&this.initTransform(!0)}if(this._keydowning)return void S.tunnelMgr.setSelectDevice(null);let a=this.GetAxisX,s=this.GetAxisY;if(this.AroundByMouseInput(),this.canRotation_X||(this.targetAngles.y=0),this.canRotation_Y||(this.targetAngles.x=0),!this.easyMode&&this.bRightMouseDown){let t=this.transform.rotationEuler.y/180*Math.PI,e=Math.sin(t),i=Math.cos(t),o=2*this.deltaTime;this.moveV3.z=-(s*i-a*e)*o,this.moveV3.x=-(s*e+a*i)*o,this.transform.translate(this.moveV3,!1),Laya.Vector3.add(this.AroundPos,this.moveV3,this.AroundPos),Laya.Vector3.add(this.curLookPos,this.moveV3,this.curLookPos),S.tunnelMgr.setSelectDevice(null)}else this.CurrentAngles=this.LerpVector3(this.CurrentAngles,this.targetAngles,this.deltaTime*this.damper),this.CurrentDistance=this.LerpNum(this.CurrentDistance,this.targetDistance,this.deltaTime*this.damper),this.CurrentAnglesTemp.x=-this.CurrentAngles.x,this.CurrentAnglesTemp.y=this.CurrentAngles.y,this.CurrentAnglesTemp.z=this.CurrentAngles.z,this.transform.rotationEuler=this.CurrentAnglesTemp,P.scale(this.GetForward,this.CurrentDistance,this.tempV),P.subtract(this.AroundPos,this.tempV,this.tempV1),this.tempV1.y=Math.max(.2,this.tempV1.y),this.transform.position=this.tempV1;this.lastMouseX=Laya.stage.mouseX,this.lastMouseY=Laya.stage.mouseY}moveForward(t,e){let a=this.transform.rotationEuler.y/180*Math.PI,s=Math.sin(a),i=Math.cos(a),o=20*this.deltaTime;this.moveV3.z=-(e*i-t*s)*o,this.moveV3.x=-(e*s+t*i)*o,this.transform.translate(this.moveV3,!1),Laya.Vector3.add(this.AroundPos,this.moveV3,this.AroundPos),Laya.Vector3.add(this.curLookPos,this.moveV3,this.curLookPos),this._keydowning=!0}moveVertical(t){this._tempVector3.x=this._tempVector3.z=0,this._tempVector3.y=t,this.camera.transform.translate(this._tempVector3,!1),this._keydowning=!0}btnClickMoveZ(t){this._tempVector3.x=this._tempVector3.y=0,this._tempVector3.z=t,this.camera.transform.translate(this._tempVector3,!1),this.curLookPos.z+=t,this.initTransform()}get GetAxisX(){return Laya.stage.mouseX-this.lastMouseX}get GetAxisY(){return Laya.stage.mouseY-this.lastMouseY}get deltaTime(){return Laya.timer.delta/1e3}get GetForward(){return this.transform.getForward(this.FORWORD),this.FORWORD}mouseDown(t){t.target.parent==Laya.Scene.root&&(this.mouseRunning=!0,this.initTransform(),this.camera.transform.localRotation.getYawPitchRoll(this.yawPitchRoll))}mouseMove(t){this.myevent=t,Laya.Browser.window.focus()}mouseWheel(t){this.easyMode&&!S.tunnelMgr.getSelectDevice()||(this.deltaWheel=t.delta)}mouseUp(t){this.mouseRunning=!1,Laya.Browser.window.focus()}rightMouseDown(t){if(S.tunnelMgr.getSelectDevice())return S.tunnelMgr.setSelectDevice(null),void S.CameraScript.clickViewReset();this.bRightMouseDown=!0}rightMouseUp(t){this.lastMouseX=Laya.stage.mouseX,this.lastMouseY=Laya.stage.mouseY,this.bRightMouseDown=!1,this.initTransform()}Clamp(t,e,a){return t<e?e:t>a?a:t}LerpVector3(t,e,a){var s=new P;return s.x=t.x+a*(e.x-t.x),s.y=t.y+a*(e.y-t.y),s.z=t.z+a*(e.z-t.z),s}LerpNum(t,e,a){return t+a*(e-t)}AroundByMouseInput(){this.mouseRunning&&(this.targetAngles.y-=this.GetAxisX*this.mouseSettings.pointerSensitivity,this.targetAngles.x+=this.GetAxisY*this.mouseSettings.pointerSensitivity,this.targetAngles.x=this.Clamp(this.targetAngles.x,this.angleRange.min,this.angleRange.max)),this.canScale&&(this.targetDistance-=this.deltaWheel*this.mouseSettings.wheelSensitivity,this.deltaWheel=0,this.targetDistance=this.Clamp(this.targetDistance,this.distanceRange.min,this.distanceRange.max))}}class M{constructor(t,e,a){this.mouseButtonID=t,this.pointerSensitivity=e,this.wheelSensitivity=a}}class k{constructor(t,e){this.min=t,this.max=e}}new class{constructor(){let t=new Config3D;t.isAntialias=!1,window.Laya3D?Laya3D.init(Laya.Browser.width,Laya.Browser.height,t):Laya.init(y.width,y.height,Laya.WebGL),Laya.Physics&&Laya.Physics.enable(),Laya.DebugPanel&&Laya.DebugPanel.enable(),Laya.stage.scaleMode=y.scaleMode,Laya.stage.screenMode=y.screenMode,Laya.stage.alignV=y.alignV,Laya.stage.alignH=y.alignH,Laya.URL.exportSceneToJson=y.exportSceneToJson,(y.debug||"true"==Laya.Utils.getQueryString("debug"))&&Laya.enableDebugPanel(),y.physicsDebug&&Laya.PhysicsDebugDraw&&Laya.PhysicsDebugDraw.enable(),y.stat&&Laya.Stat.show(),Laya.alertGlobalError(!0),Laya.ResourceVersion.enable(Laya.Browser.window._VERSION_JSON||"version.json",Laya.Handler.create(this,this.onVersionLoaded),Laya.ResourceVersion.FILENAME_VERSION)}onVersionLoaded(){Laya.AtlasInfoManager.enable("fileconfig.json",Laya.Handler.create(this,this.onConfigLoaded))}onConfigLoaded(){Laya.Scene3D.load("res/LayaScene_suidao/Conventional/suidao.ls",Laya.Handler.create(this,this.onLoadScene))}onLoadScene(t){if(Laya.stage.addChild(t),S.GameScene=t,S.GameCamera=t.getChildByName("Main Camera"),S.GameCamera.addComponent(V),S.GameCamera.farPlane=1e3,S.GameCamera.fieldOfView=40,S.tunnelMgr.init(t),Laya.Browser.window.focus(),Laya.Browser.window.addEventListener("message",function(t){let e=t.data;switch(e.msgType){case"loadTunnel":S.tunnelMgr.InitData||(S.tunnelMgr.loadTunnel(e.msgData,e.addData),y.startScene&&Laya.Scene.open(y.startScene));break;case"addDevice":S.tunnelMgr.addDevice(e.msgData);break;case"addDevices":S.tunnelMgr.addDevices(e.msgData);break;case"setAutoView":S.CameraScript.autoView(e.msgData);break;case"resetView":S.CameraScript.reset();break;case"focus":Laya.Browser.window.focus();break;case"selectDevice":let t=S.tunnelMgr.findDevice(e.msgData);t&&t.getChildAt(0).getComponent(a).cameraMoveToLook(!1)}}),Laya.Browser.window.parent){let t={msgType:"loaded"};Laya.Browser.window.parent.postMessage(t)}t.enableLight=!1}}}();